# Build Implementation Plan - Option C: Zip Archive with Installer

## Overview
This document focuses exclusively on implementing Option C (Zip Archive with Installer) for the RDD framework release system. The legacy `scripts/build.sh` will be replaced with a new Python-based `scripts/build.py` that creates a single cross-platform release archive.

## Key Decisions

### Single Cross-Platform Archive
- **What**: Create one zip archive that works on all platforms (Windows, Linux, macOS)
- **Why**: Python is cross-platform, no need for separate builds
- **Archive Name**: `rdd-v{version}.zip`
- **No Platform Suffix**: Removed -linux, -windows suffixes

### Python-Only Build System
- **Replace**: `scripts/build.sh` (bash)
- **With**: `scripts/build.py` (Python)
- **Benefits**:
  - Cross-platform build process
  - Consistent with framework's Python-first approach
  - No bash-to-PowerShell conversion needed
  - Easier to maintain and extend

### Self-Contained Installer
- **Included**: `install.py` in the archive
- **No Dependencies**: Uses only Python standard library
- **Interactive**: Prompts user for confirmation and options
- **Automated**: Can also be scripted for CI/CD

## Architecture

### Release Archive Structure
```
rdd-v{version}.zip
├── install.py              # Python installation script (self-contained)
├── README.md               # Installation guide and quick start
├── LICENSE                 # Project license
├── .github/
│   └── prompts/            # All *.prompt.md files
│       ├── rdd.01-initiate.prompt.md
│       ├── rdd.02-clarify-requirements.prompt.md
│       ├── rdd.06-execute.prompt.md
│       └── ... (all prompts)
├── .rdd/
│   ├── scripts/            # Python automation scripts
│   │   ├── rdd.py          # Main entry point
│   │   └── rdd_utils.py    # Utility functions
│   └── templates/          # All template files
│       ├── copilot-prompts.md
│       ├── requirements.md
│       ├── tech-spec.md
│       └── ... (all templates)
└── .vscode/
    └── settings.json       # VS Code settings template (for merging)
```

### Component Responsibilities

#### scripts/build.py
**Purpose**: Build orchestration - creates the release archive

**Responsibilities**:
1. Extract version from `.rdd/scripts/rdd.py`
2. Validate version follows SemVer format
3. Clean and create build directory structure
4. Copy all required files to build staging area:
   - Prompts from `.github/prompts/`
   - Scripts: `rdd.py`, `rdd_utils.py`
   - Templates from `.rdd/templates/`
   - VS Code settings template
   - LICENSE file
5. Generate `install.py` in staging area
6. Generate `README.md` with installation instructions
7. Create zip archive: `build/rdd-v{version}.zip`
8. Generate SHA256 checksum file
9. Clean up staging directory

**Key Features**:
- Uses Python `pathlib` for cross-platform path handling
- Comprehensive error handling with clear messages
- Progress reporting during build
- Validation of all inputs and outputs
- Exit codes for CI/CD integration

#### install.py (Generated by build.py)
**Purpose**: User-facing installation automation

**Responsibilities**:
1. **Pre-flight Checks**:
   - Verify Python version >= 3.7
   - Check Git is installed
   - Validate target directory is Git repository
   - Detect existing RDD installation

2. **Interactive Installation**:
   - Prompt for target directory (default: current)
   - Warn if existing installation found
   - Get user confirmation to proceed

3. **File Operations**:
   - Copy `.github/prompts/` to target
   - Copy `.rdd/` framework to target
   - Set executable permissions on `rdd.py` (Linux/macOS)
   - Merge `.vscode/settings.json` with existing
   - Update `.gitignore` with workspace exclusion

4. **Verification**:
   - Confirm all files copied
   - Test RDD command: `python .rdd/scripts/rdd.py --version`
   - Report installation success

5. **Error Handling**:
   - Clear error messages for all failure scenarios
   - Suggestions for fixing common issues
   - Graceful exit on any error

**Key Features**:
- Self-contained (no dependencies beyond Python stdlib)
- Idempotent (can run multiple times safely)
- Interactive with sensible defaults
- Comprehensive validation

#### README.md (Generated by build.py)
**Purpose**: First document users see after extracting archive

**Content**:
1. **What is RDD**: Brief framework description
2. **System Requirements**:
   - Python 3.7+ (note about `python` vs `python3`)
   - Git 2.23+
   - VS Code (recommended)
   - GitHub Copilot (optional)
3. **Quick Installation**:
   - Extract this archive
   - Run: `python install.py`
   - Follow prompts
4. **Manual Installation**: Step-by-step fallback
5. **Verification**: How to test installation
6. **Getting Started**: First command to run
7. **Troubleshooting**: Common issues and solutions

## Build Process Flow

### Step-by-Step Build Process

```
[Start] → [Extract Version] → [Validate Version] → [Create Build Dir]
            ↓                      ↓                    ↓
    From rdd.py           Check SemVer         build/rdd-v{version}/
            ↓                      ↓                    ↓
    __version__ var        Exit if invalid     Create subdirs
            
            ↓
    [Copy Files]
            ↓
    ├── Copy .github/prompts/*.prompt.md
    ├── Copy .rdd/scripts/rdd.py
    ├── Copy .rdd/scripts/rdd_utils.py
    ├── Copy .rdd/templates/* (all files)
    ├── Copy LICENSE
    └── Copy .rdd/templates/settings.json → .vscode/settings.json
            
            ↓
    [Generate Files]
            ↓
    ├── Generate install.py (from template/code)
    └── Generate README.md (from template/code)
            
            ↓
    [Create Archive]
            ↓
    Create build/rdd-v{version}.zip
    (contains entire rdd-v{version}/ directory)
            
            ↓
    [Generate Checksum]
            ↓
    Create build/rdd-v{version}.zip.sha256
    (SHA256 hash of zip file)
            
            ↓
    [Cleanup]
            ↓
    Remove build/rdd-v{version}/ staging directory
    Keep only .zip and .sha256 files
            
            ↓
    [Report Success]
            ↓
    Display:
    - Version built
    - Archive location and size
    - Checksum file location
    - Next steps
            
    [End]
```

### Installation Process Flow

```
[User Extracts Archive]
            ↓
    [User Runs: python install.py]
            ↓
    [Pre-flight Checks]
            ↓
    ├── Check Python >= 3.7
    ├── Check Git installed
    └── Check target is Git repo
            ↓
    [Detect Existing Installation]
            ↓
    Check for:
    - .rdd/scripts/rdd.py
    - .github/prompts/*.prompt.md
            ↓
    [User Interaction]
            ↓
    ├── Prompt for target directory
    ├── Warn if existing installation
    └── Get confirmation to proceed
            ↓
    [Install Files]
            ↓
    ├── Copy prompts → target/.github/prompts/
    ├── Copy .rdd/ → target/.rdd/
    ├── chmod +x target/.rdd/scripts/rdd.py (Unix)
    ├── Merge settings → target/.vscode/settings.json
    └── Update target/.gitignore
            ↓
    [Verification]
            ↓
    ├── Check all files present
    └── Test: python .rdd/scripts/rdd.py --version
            ↓
    [Report Success]
            ↓
    Display:
    - Installation location
    - Verification results
    - Next steps
    - Link to documentation
            ↓
    [End]
```

## VS Code Settings Merge Logic

The installer must intelligently merge VS Code settings without overwriting user customizations.

### Settings to Merge

#### chat.promptFilesRecommendations (Array)
- **Strategy**: Append unique values
- **Example**:
  ```json
  // Existing
  {"chat.promptFilesRecommendations": ["custom-prompt.md"]}
  
  // From RDD
  {"chat.promptFilesRecommendations": [
    "rdd.01-initiate.prompt.md",
    "rdd.02-clarify-requirements.prompt.md"
  ]}
  
  // Merged Result
  {"chat.promptFilesRecommendations": [
    "custom-prompt.md",
    "rdd.01-initiate.prompt.md",
    "rdd.02-clarify-requirements.prompt.md"
  ]}
  ```

#### chat.tools.terminal.autoApprove (Array)
- **Strategy**: Append unique values
- **Example**:
  ```json
  // Existing
  {"chat.tools.terminal.autoApprove": ["custom-script.sh"]}
  
  // From RDD
  {"chat.tools.terminal.autoApprove": ["python .rdd/scripts/rdd.py"]}
  
  // Merged Result
  {"chat.tools.terminal.autoApprove": [
    "custom-script.sh",
    "python .rdd/scripts/rdd.py"
  ]}
  ```

#### files.associations (Object)
- **Strategy**: Merge keys, RDD values take precedence
- **Example**:
  ```json
  // Existing
  {"files.associations": {"*.custom": "json"}}
  
  // From RDD
  {"files.associations": {"*.jsonl": "jsonlines"}}
  
  // Merged Result
  {"files.associations": {
    "*.custom": "json",
    "*.jsonl": "jsonlines"
  }}
  ```

#### editor.rulers (Array)
- **Strategy**: Use RDD values (replace)
- **Rationale**: RDD requires specific ruler positions
- **Example**:
  ```json
  // Existing
  {"editor.rulers": [100]}
  
  // From RDD
  {"editor.rulers": [80, 120]}
  
  // Merged Result
  {"editor.rulers": [80, 120]}
  ```

### Merge Algorithm
```python
def merge_vscode_settings(source_settings, target_settings):
    merged = target_settings.copy()
    
    # Arrays: append unique
    for key in ['chat.promptFilesRecommendations', 
                'chat.tools.terminal.autoApprove']:
        if key in source_settings:
            existing = set(merged.get(key, []))
            new_items = source_settings[key]
            merged[key] = list(existing) + [
                item for item in new_items if item not in existing
            ]
    
    # Object: merge keys
    if 'files.associations' in source_settings:
        merged.setdefault('files.associations', {})
        merged['files.associations'].update(
            source_settings['files.associations']
        )
    
    # Array: replace
    if 'editor.rulers' in source_settings:
        merged['editor.rulers'] = source_settings['editor.rulers']
    
    return merged
```

## .gitignore Update Logic

The installer must add `.rdd-docs/workspace/` to `.gitignore` without duplication.

### Update Algorithm
```python
def update_gitignore(target_dir):
    gitignore_path = target_dir / '.gitignore'
    workspace_entry = '.rdd-docs/workspace/'
    
    # Read existing or create empty
    if gitignore_path.exists():
        lines = gitignore_path.read_text().splitlines()
    else:
        lines = []
    
    # Check if already present (various forms)
    patterns = [
        '.rdd-docs/workspace/',
        '.rdd-docs/workspace',
        '.rdd-docs/workspace/*',
    ]
    
    for line in lines:
        if any(pattern in line for pattern in patterns):
            print(".gitignore already contains workspace exclusion")
            return False
    
    # Add entry
    if lines and lines[-1].strip():  # Add blank line if needed
        lines.append('')
    lines.append('# RDD framework workspace (auto-generated)')
    lines.append(workspace_entry)
    
    # Write back
    gitignore_path.write_text('\n'.join(lines) + '\n')
    return True
```

## Version Management

### Single Source of Truth
- **Location**: `.rdd/scripts/rdd.py`
- **Format**: `__version__ = "X.Y.Z"`
- **Example**:
  ```python
  # In rdd.py
  __version__ = "1.0.0"
  RDD_VERSION = __version__
  ```

### Version Extraction
```python
import re

def extract_version(rdd_py_path):
    content = rdd_py_path.read_text()
    match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
    if not match:
        raise ValueError("Could not find __version__ in rdd.py")
    
    version = match.group(1)
    
    # Validate SemVer format
    if not re.match(r'^\d+\.\d+\.\d+$', version):
        raise ValueError(f"Invalid version format: {version}")
    
    return version
```

### Version in Archive Name
- **Format**: `rdd-v{version}.zip`
- **Examples**: 
  - `rdd-v1.0.0.zip`
  - `rdd-v1.2.3.zip`
  - `rdd-v2.0.0.zip`

## Error Handling Strategy

### Build Script Errors
- **Missing Source Files**: Exit with clear message listing missing files
- **Invalid Version**: Exit with message showing found vs expected format
- **Build Directory Issues**: Exit with permission or disk space error
- **Zip Creation Fails**: Exit with filesystem error details

### Installer Script Errors
- **Python Too Old**: Show current version, required version, upgrade link
- **Git Not Found**: Show installation instructions for user's OS
- **Not a Git Repo**: Show `git init` command, explain requirement
- **Permission Denied**: Show chmod command, explain file permissions
- **Settings Merge Fails**: Continue with warning, don't fail installation

### Recovery Strategies
- **Build Fails**: Clean up partial build, allow retry
- **Install Fails**: Don't leave partial installation, rollback if possible
- **User Cancels**: Clean exit, no changes made

## Security Considerations

### Build Security
- **No External Dependencies**: Build uses only Python stdlib
- **File Validation**: Verify all source files exist before copying
- **Clean Build**: Always start with clean build directory
- **Checksum Integrity**: SHA256 for archive verification

### Installer Security  
- **No Arbitrary Execution**: No eval, exec, or shell injection risks
- **Path Validation**: Validate all paths before operations
- **Permission Checks**: Verify write permissions before copying
- **Input Validation**: Sanitize all user inputs

### Archive Security
- **No Secrets**: Archive contains no sensitive data
- **File Permissions**: Preserve security-relevant permissions
- **Read-Only License**: LICENSE file clearly visible
- **Audit Trail**: User can inspect archive before running installer

## Testing Strategy

### Build Testing
1. **Clean Build**: Test on fresh checkout
2. **Rebuild**: Test with existing build/ directory
3. **Version Extraction**: Test with various version formats
4. **Missing Files**: Test error handling for missing sources
5. **Archive Integrity**: Verify zip extracts correctly
6. **Checksum**: Verify SHA256 is correct

### Installation Testing
1. **Fresh Install**: Test in empty Git repo
2. **Existing Install**: Test overwrite behavior
3. **Non-Git Directory**: Test error handling
4. **Settings Merge**: Test with various existing settings
5. **gitignore Update**: Test with various existing gitignores
6. **Permissions**: Test on Linux/macOS vs Windows

### Integration Testing
1. **End-to-End**: Build → Extract → Install → Verify
2. **RDD Workflow**: Install → Run RDD commands → Complete workflow
3. **Multiple Installs**: Install → Update → Verify

### Platform Testing
- **Linux**: Primary target, full test suite
- **macOS**: File permissions, path handling
- **Windows**: Path separators, no chmod

## Documentation Requirements

### For Users (README.md in archive)
- Clear installation instructions
- System requirements
- Troubleshooting common issues
- Next steps after installation

### For Maintainers (RELEASE-PROCESS.md)
- How to create releases
- Version bumping procedure
- Build process explanation
- Troubleshooting build issues

### For Developers (INSTALLATION.md)
- Detailed installation guide
- Platform-specific notes
- Manual installation steps
- Uninstallation procedure

## Implementation Prompts

The implementation is divided into detailed prompts (P03-P07) that specify:

### P03: Implement build.py
- Complete build orchestration script
- Version extraction and validation
- File copying and organization
- Archive and checksum generation
- Error handling and reporting

### P04: Implement install.py  
- Pre-flight validation
- Interactive user prompts
- File installation operations
- VS Code settings merge
- gitignore update
- Installation verification

### P05: GitHub Actions Release Workflow
- Automated release creation
- Tag-based triggering
- Build artifact generation
- Release notes automation
- Asset attachment

### P06: Documentation Updates
- CHANGELOG.md creation
- RELEASE-PROCESS.md for maintainers
- README.md installation section
- INSTALLATION.md detailed guide
- Technical documentation updates

### P07: Testing and Validation
- Comprehensive test suite
- End-to-end validation
- Legacy file cleanup
- Performance testing
- Security audit
- Final sign-off

## Migration from Current System

### Files to Remove
- `scripts/build.sh` - Replaced by build.py
- `scripts/bash-to-powershell.py` - No longer needed
- `src/linux/` - Platform-specific code no longer needed
- `src/windows/` - Platform-specific code no longer needed

### Files to Create
- `scripts/build.py` - New Python build script
- `.github/workflows/release.yml` - Automated release workflow
- `CHANGELOG.md` - Version history
- `RELEASE-PROCESS.md` - Maintainer guide
- `INSTALLATION.md` - Detailed user guide

### Files to Update
- `README.md` - Add installation section
- `.rdd-docs/tech-spec.md` - Update build system section
- `.rdd-docs/folder-structure.md` - Update structure

## Success Criteria

### Build System
- ✅ Single command builds release: `python scripts/build.py`
- ✅ Archive contains all required files
- ✅ Checksum file generated correctly
- ✅ Build completes in < 30 seconds
- ✅ Works on Linux, macOS, Windows

### Installer
- ✅ Installation is interactive and user-friendly
- ✅ Handles existing installations gracefully
- ✅ Merges VS Code settings correctly
- ✅ Updates .gitignore without duplication
- ✅ Verifies installation success
- ✅ Works on Linux, macOS, Windows

### Documentation
- ✅ README.md is clear and complete
- ✅ INSTALLATION.md covers all scenarios
- ✅ RELEASE-PROCESS.md guides maintainers
- ✅ CHANGELOG.md tracks versions
- ✅ All commands in docs work

### Automation
- ✅ GitHub Actions workflow succeeds
- ✅ Releases created automatically on tags
- ✅ Artifacts attached to releases
- ✅ Release notes generated

### Quality
- ✅ All tests pass
- ✅ No security issues
- ✅ Performance acceptable
- ✅ Error messages helpful
- ✅ Code maintainable

## Timeline Estimate

- **P03 (build.py)**: 3-4 hours
- **P04 (install.py)**: 3-4 hours
- **P05 (GitHub Actions)**: 1-2 hours
- **P06 (Documentation)**: 2-3 hours
- **P07 (Testing)**: 3-4 hours

**Total**: 12-17 hours of implementation time

## Conclusion

This plan provides a clear path to implementing a modern, Python-based build and release system for the RDD framework. The focus on Option C (Zip Archive with Installer) simplifies the architecture by:

1. Eliminating platform-specific builds (Python is cross-platform)
2. Removing bash-to-PowerShell conversion (no longer needed)
3. Providing self-contained installer (no external dependencies)
4. Automating releases via GitHub Actions

The detailed prompts (P03-P07) ensure that implementation can proceed systematically with clear expectations and success criteria at each step.
